<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Property.Address}} — House Finder</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/htmx.min.js"></script>
</head>
<script>
    (function(){var t=localStorage.getItem('theme')||(matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light');document.documentElement.setAttribute('data-theme',t);})();
</script>
<body>
    <header>
        <h1><a href="/">House Finder</a></h1>
        <a href="/settings" class="settings-icon" aria-label="Settings"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></a>
    </header>
    <main>
        <a href="/" class="back-link">← All Properties</a>

        {{if .Property.PhotoURL}}
        <div class="hero-photo">
            <img src="{{.Property.PhotoURL}}" alt="{{.Property.Address}}">
        </div>
        {{end}}

        <div class="card">
            <h2>{{.Property.Address}}</h2>
            <div class="detail-grid">
                <div class="detail-item">
                    <label>Price</label>
                    <span>{{formatPrice .Property.Price}}</span>
                </div>
                <div class="detail-item">
                    <label>Bedrooms</label>
                    <span>{{formatFloat .Property.Bedrooms}}</span>
                </div>
                <div class="detail-item">
                    <label>Bathrooms</label>
                    <span>{{formatFloat .Property.Bathrooms}}</span>
                </div>
                <div class="detail-item">
                    <label>Sqft</label>
                    <span>{{formatInt .Property.Sqft}}</span>
                </div>
                <div class="detail-item">
                    <label>Lot Size</label>
                    <span>{{formatLot .Property.LotSize}}</span>
                </div>
                <div class="detail-item">
                    <label>Year Built</label>
                    <span>{{formatInt .Property.YearBuilt}}</span>
                </div>
                <div class="detail-item">
                    <label>Type</label>
                    <span>{{formatStr .Property.PropertyType}}</span>
                </div>
                <div class="detail-item">
                    <label>Status</label>
                    <span>{{formatStr .Property.Status}}</span>
                </div>
            </div>
            {{if .Property.RealtorURL}}
            <a href="{{.Property.RealtorURL}}" target="_blank" class="realtor-link">View on Realtor.com →</a>
            {{end}}
        </div>

        {{template "rating-partial" .}}

        <div class="card" id="visit-status-card">
            <div class="visit-status-row">
                <span class="visit-status-label">Status: <strong id="visit-status-text">{{if eq .Property.VisitStatus "not_visited"}}Not Visited{{else if eq .Property.VisitStatus "want_to_visit"}}Want to Visit{{else}}Visited{{end}}</strong></span>
                <div class="visit-status-actions">
                    {{if eq .Property.VisitStatus "not_visited"}}
                    <button class="btn" id="status-advance-btn" onclick="setVisitStatus({{.Property.ID}}, 'want_to_visit')">Want to Visit</button>
                    {{else if eq .Property.VisitStatus "want_to_visit"}}
                    <button class="btn" id="status-advance-btn" onclick="setVisitStatus({{.Property.ID}}, 'visited')">Mark Visited</button>
                    <button class="btn btn-secondary" onclick="setVisitStatus({{.Property.ID}}, 'not_visited')">← Back</button>
                    {{else}}
                    <button class="btn btn-secondary" onclick="setVisitStatus({{.Property.ID}}, 'want_to_visit')">← Want to Visit</button>
                    <button class="btn btn-secondary" onclick="setVisitStatus({{.Property.ID}}, 'not_visited')">← Not Visited</button>
                    {{end}}
                </div>
            </div>
        </div>

        <div class="card" id="visits-section">
            <h2>Visits</h2>
            <div id="visits-list"></div>
            <div class="visit-form">
                <div class="form-row">
                    <input type="date" id="visit-date" class="login-input">
                    <select id="visit-type" class="login-input">
                        <option value="showing">Showing</option>
                        <option value="drive_by">Drive-by</option>
                        <option value="open_house">Open House</option>
                    </select>
                </div>
                <div class="form-row">
                    <input type="text" id="visit-notes" placeholder="Notes (optional)" class="login-input" style="flex:1;">
                    <button class="btn" onclick="addVisit({{.Property.ID}})">Add Visit</button>
                </div>
            </div>
            <div id="visit-status" class="passkey-status"></div>
        </div>

        <div class="card" id="comments-section">
            <h2>Comments</h2>
            {{template "comments-partial" .}}
            <div class="comment-form">
                <form hx-post="/property/{{.Property.ID}}/comment" hx-target="#comments-list" hx-swap="outerHTML"
                      hx-on::after-request="this.reset()">
                    <textarea name="text" placeholder="Add a comment..." required></textarea>
                    <button type="submit" class="btn">Add Comment</button>
                </form>
            </div>
        </div>
    </main>
    <script>
    function escapeHtml(s) {
        var d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
    }

    async function setVisitStatus(propID, status) {
        try {
            var resp = await fetch('/api/properties/' + propID + '/status', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({visit_status: status})
            });
            if (!resp.ok) throw new Error('Failed to update');
            // Reload page to update button state
            window.location.reload();
        } catch (e) {
            alert('Failed to update status: ' + e.message);
        }
    }

    var visitTypeLabels = {showing: 'Showing', drive_by: 'Drive-by', open_house: 'Open House'};

    async function loadVisits(propID) {
        var container = document.getElementById('visits-list');
        try {
            var resp = await fetch('/api/properties/' + propID + '/visits');
            if (!resp.ok) throw new Error('Failed to load visits');
            var visits = await resp.json();
            if (!visits || visits.length === 0) {
                container.innerHTML = '<p class="empty">No visits yet.</p>';
                return;
            }
            var html = '';
            for (var v of visits) {
                html += '<div class="comment"><div class="meta">' + escapeHtml(v.visit_date) + ' — ' + escapeHtml(visitTypeLabels[v.visit_type] || v.visit_type) + '</div>';
                if (v.notes) html += '<div>' + escapeHtml(v.notes) + '</div>';
                html += '</div>';
            }
            container.innerHTML = html;
        } catch (err) {
            container.innerHTML = '<p class="passkey-error">Failed to load visits.</p>';
        }
    }

    async function addVisit(propID) {
        var dateInput = document.getElementById('visit-date');
        var typeInput = document.getElementById('visit-type');
        var notesInput = document.getElementById('visit-notes');
        var statusEl = document.getElementById('visit-status');
        if (!dateInput.value) {
            statusEl.textContent = '✗ Date is required';
            statusEl.className = 'passkey-status passkey-error';
            return;
        }
        try {
            var resp = await fetch('/api/properties/' + propID + '/visits', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({visit_date: dateInput.value, visit_type: typeInput.value, notes: notesInput.value.trim()})
            });
            if (!resp.ok) {
                var data = await resp.json();
                throw new Error(data.error || 'Failed to add visit');
            }
            statusEl.textContent = '✓ Visit recorded';
            statusEl.className = 'passkey-status passkey-success';
            notesInput.value = '';
            loadVisits(propID);
            // Reload to update visit status button (auto-set to visited)
            setTimeout(function() { window.location.reload(); }, 1000);
        } catch (err) {
            statusEl.textContent = '✗ ' + err.message;
            statusEl.className = 'passkey-status passkey-error';
        }
    }

    loadVisits({{.Property.ID}});
    </script>
</body>
</html>

{{define "comments-partial"}}
<div id="comments-list">
    {{if .Comments}}
    {{range .Comments}}
    <div class="comment">
        <div class="meta">{{.CreatedAt.Format "Jan 2, 2006 3:04 PM"}}{{if .Author}} — {{.Author}}{{end}}</div>
        <div>{{.Text}}</div>
    </div>
    {{end}}
    {{else}}
    <div class="empty">No comments yet.</div>
    {{end}}
</div>
{{end}}

{{define "rating-partial"}}
<div class="card" id="rating-card">
    <h2>Rating</h2>
    <div class="rating-form">
        {{range $i := seq 1 4}}
        <button class="rating-btn{{if eq (derefRating $.Property.Rating) $i}} active{{end}}"
                hx-post="/property/{{$.Property.ID}}/rate"
                hx-vals='{"rating": "{{$i}}"}'
                hx-target="#rating-card"
                hx-swap="outerHTML">
            {{$i}}
        </button>
        {{end}}
    </div>
</div>
{{end}}
